<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>個数入力 - <%= date %></title>
  <link rel="stylesheet" href="/css/style.css">
</head>
<body>
  <h1>個数入力（<%= date %>）</h1>
  <form id="quantityForm">
    <% const items = ['一般宅配','代引き','着払い&クール','指定場所','160S','170S','180S','200S','集荷','商業','メール便']; %>
    <% items.forEach(function(item) { %>
      <div class="form-row">
        <label><%= item %>:</label>
        <input type="number" name="<%= item %>" value="0" min="0" onchange="calculateSubtotal()">
        <span class="subtotal" id="subtotal-<%= item %>">¥0</span>
      </div>
    <% }); %>
    <button type="button" onclick="submitForm()">完了</button>
    <button type="button" onclick="window.history.back()">キャンセル</button>
  </form>
  <script>
    // 仮の運賃定義は API 経由で取得することも可能ですが、ここでは簡易的に
    const fares = <%- JSON.stringify(user.fares) %>;
    
    function calculateSubtotal() {
      const form = document.getElementById('quantityForm');
      for (let key in fares) {
        const qty = parseInt(form.elements[key].value) || 0;
        const subtotal = qty * fares[key];
        document.getElementById('subtotal-' + key).textContent = '¥' + subtotal;
      }
    }

    async function submitForm() {
      const form = document.getElementById('quantityForm');
      const data = { date: "<%= date %>", quantities: {} };
      for (let key in fares) {
        data.quantities[key] = parseInt(form.elements[key].value) || 0;
      }
      const response = await fetch('/api/record', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      });
      if (response.ok) {
        alert("保存しました");
        window.location.href = '/dashboard';
      } else {
        alert("保存に失敗しました");
      }
    }
  </script>
</body>
</html>
